<div class="modal-overlay" *ngIf="isOpen" (click)="onClose()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    
    <div class="modal-header">
      <h2>üìù Zap√≠sa≈• doch√°dzku</h2>
      <button class="close-btn" (click)="onClose()">‚úï</button>
    </div>

    <div class="modal-body">
      
      <div class="form-section highlight-bg" *ngIf="canSelectUser">
          <label>Zamestnanec</label>
          <select [ngModel]="userId" (ngModelChange)="onUserChange($event)" class="modern-input user-select">
              <option *ngFor="let u of users" [value]="u.id">
                  {{ u.first_name }} {{ u.last_name }} ({{ u.username }})
              </option>
          </select>
      </div>

      <div class="form-section">
        <label>D√°tum</label>
        
        <input type="date" 
               [(ngModel)]="formDate" 
               (change)="onDateChange()" 
               class="modern-input"
               [disabled]="!!selectedPlanId"
               title="Ak chcete zmeni≈• d√°tum, zru≈°te v√Ωber pl√°nu ni≈æ≈°ie">
        
        <div class="plan-selector" *ngIf="availablePlans.length > 0">
           <label class="small-label">Dostupn√© pl√°ny pre tento de≈à:</label>
           
           <select [(ngModel)]="selectedPlanId" (change)="onPlanSelectChange()" class="plan-dropdown">
              <option [ngValue]="null">-- Bez v√§zby na pl√°n (Vytvori≈• nov√Ω) --</option>
              
              <option *ngFor="let plan of availablePlans" [ngValue]="plan.id">
                 üïí {{ plan.shift_name || 'Smena' }} ({{ plan.custom_start | slice:0:5 }} - {{ plan.custom_end | slice:0:5 }})
              </option>
           </select>
           
           <div class="status-badge success" *ngIf="selectedPlanId">
              Linked ‚úÖ
           </div>
        </div>

        <div *ngIf="availablePlans.length === 0" class="plan-badge not-found">
           ‚ö†Ô∏è ≈Ωiadny otvoren√Ω pl√°n na tento de≈à (Vytv√°rate z√°znam mimo pl√°nu)
        </div>
      </div>

      <div class="grid-row">
        <div class="form-group">
          <label>Typ smeny</label>
          <select [(ngModel)]="selectedTypeId" class="modern-input">
            <option [ngValue]="null">-- Vyberte --</option>
            <option *ngFor="let t of shiftTypes" [value]="t.id">{{ t.nameShift }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Pr√≠chod</label>
          <input type="time" [(ngModel)]="formStart" (change)="checkDiff()" class="modern-input">
        </div>

        <div class="form-group">
          <label>Odchod</label>
          <input type="time" [(ngModel)]="formEnd" (change)="checkDiff()" class="modern-input">
        </div>
      </div>

      <div class="reason-section" [class.visible]="isTimeChanged">
        <div class="info-text">
          üïí ƒåasy sa l√≠≈°ia od vybran√©ho pl√°nu (alebo pl√°n ch√Ωba). Pros√≠m, uveƒète d√¥vod.
        </div>
        <label>D√¥vod zmeny *</label>
        <select [(ngModel)]="selectedReasonId" class="modern-input highlight">
          <option [ngValue]="null">-- Vyberte d√¥vod --</option>
          <option *ngFor="let r of reasons" [value]="r.id">{{ r.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>Pozn√°mka</label>
        <textarea [(ngModel)]="formNote" rows="2" class="modern-input" placeholder="Voliteƒæn√° pozn√°mka..."></textarea>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="onClose()">Zru≈°i≈•</button>
      <button class="btn btn-primary" (click)="onSave()">Ulo≈æi≈• Z√°znam</button>
    </div>

  </div>
</div>